# redis复制功能

### 旧版复制功能实现

- redis中，用户可以通过SLAVEOF命令让一个服务器去复制另一个服务器，被复制的服务器叫做主服务器，进行复制的服务器叫从服务器，可以夸机器去进行复制。有主从就肯定有数据一致性的问题。

- 旧版复制功能的实现有两个操作，同步和命令传播，同步就是把从服务器更新到主服务器的状态，命令传播就是主服务器的数据库被修改的时候，同时发命令给从服务器，更改从服务器。

- 同步的步骤，首先从服务器向主服务器发送SYNC命令，主服务器接收到命令后，执行BGSAVE命令（RBD持久化），生成一个RBD文件，之后用一个缓冲区，开始记录所有的写命令，之后会把RBD文件发送给从服务器，从服务器接收后将状态更新至BGSAVE命令执行完的状态，之后主服务器将缓冲区里的写命令发过去，从服务器执行，将自己的数据库更新。

- 命令传播，即每当主服务器执行写命令的时候，将它发送给从服务器，从服务器执行相同的写命令。

- 缺点：在断线重连的时候重新执行了同步的步骤，同步的步骤需要发送这个RBD结构，重新载入所有的键，这个效率是很低下的，因为其实之前可能有很多键是正确的不需要重载，但是，SYNC命令强行全部重载了。

### 新版复制功能实现

- 使用PSYNC命令代替SYNC，PSYNC命令有完全重同步和部分重同步的功能，完全重同步就是SYNC功能，部分重同步应用于断线后处理重连，主服务器将服务器断线这段时间的执行的写命令发送给从服务器，从服务器只要接收这些写命令写入就好了。

- 部分重同步的实现，主要由一下三个部分组成，主服务器的复制偏移量，和从服务器的复制偏移量，主服务器的复制缓冲区，服务器的运行ID，偏移量主从服务器各一份，主服务器每次像从服务器传播N个字节的数据时，就把偏移量加N，同样，从服务器就是接受N个字节，偏移量+N，通过偏移量我们可以很快的清楚主从服务器是否处于一致，复制缓冲区是一个先进先出的队列，大小为1MB，当从服务器重新连上主服务器时，从服务器会通过PSYNC把自己的偏移量发过去，进行判断，如果不一致，主服务器会通过偏移量，去复制缓冲区去拿出写命令数据发送给从服务器，之后就可以和主服务恢复一样的状态，这个ID的作用就是，当前从服务器断开连接后去链接另一个主服务器，两个ID对不上就重新执行SYNC，之后再把ID改成一致，这个ID服务器启东时生成，由40个随机的16进制数组成。

- 只讨论原理，PSYNC具体的使用其实还有很多细节，具体可以百度查看，这里不细说。

- 在redisServer结构里，从服务器有保存其主服务器信息的结构。SLAVEOF命令是一个异步命令，从服务器
有一个套接字专门关联了处理复制工作的文件事件（事件之前redis服务器有讲），而主服务器在接收到连接后将从服务器当作一个客户端来看待，从服务器可以主服务器发送命令请求，而主服务器则会向从服务器返回命令回复。

```cpp
    char *masterauth;               /* AUTH with this password with master */
    char *masterhost;               /* Hostname of master */
```

- 当从服务连接主服务器会首先ping，看看可不可以ping通或者主服务器是否可以接受复制，如果可以的话，进行身份验证，如果设置了masterauth选项，那么进行身份验证，否则不进行，身份验证这里不细说了，之后从服务器向主服务器发送端口号，之后连接上便开始同步。如果执行的是重同步，那么主服务器可以看作是从服务器的客户端，来发送命令。之后连接上每次主服务器的写操作都要进行命令传播。

- 心跳，从服务器每秒会向主服务器发送命令，主要的用处有三个，检测主从服务器的网络连接状态，辅助min-slaves选项，检测命令丢失。如果当主服务器没有接收到从服务器的心跳包，主服务器便知道与从服务器的连接出现了问题，redis的min-slaves-to-write和min-slaves-to-log两个选项可以防止主服务器在不安全的情况下执行写命令，第一个是从服务器不得超过的数量，第二个是所有从服务器的延迟时间都大于，如果这两个命令有一个不符合，主服务器就不做写命令执行。检测命令丢失就是在网络传输的过程中丢失了，那么从服务器像主服务器发送ACK时，主服务器会查看一边命令缓冲区和偏移量，发现从服务器的少于自己后，再从内存缓冲区里取出重新发送。
